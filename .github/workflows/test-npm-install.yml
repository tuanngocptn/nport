name: Test NPM Install

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'NPM package version/tag to test (e.g., 2.1.1, latest)'
        required: true
        default: 'latest'
        type: string

jobs:
  test-install:
    strategy:
      fail-fast: false
      matrix:
        os:
          # Linux (x64)
          - ubuntu-latest
          - ubuntu-24.04
          - ubuntu-22.04
          # Windows (x64)
          - windows-latest
          - windows-2025
          - windows-2022
          # macOS Intel (x64)
          - macos-13
          # macOS ARM64 (M1/M-series)
          - macos-latest
          - macos-14
          - macos-15

    runs-on: ${{ matrix.os }}
    name: Test on ${{ matrix.os }}

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install nport from npm
        run: npm install -g nport@${{ inputs.version }}

      - name: Verify nport installation
        run: nport --version

      - name: Run nport and check for errors (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Starting nport on port 3000..."
          
          # Start nport in background and capture output
          nport 3000 -l en -s test-${{ matrix.os }}-${{ github.run_id }} > nport_output.log 2>&1 &
          NPORT_PID=$!
          
          echo "nport started with PID: $NPORT_PID"
          
          # Wait 30 seconds
          echo "Waiting 30 seconds..."
          sleep 30
          
          # Check if process is still running
          if kill -0 $NPORT_PID 2>/dev/null; then
            echo "✅ nport is still running after 30 seconds"
            PROCESS_RUNNING=true
          else
            echo "⚠️ nport process has stopped"
            PROCESS_RUNNING=false
          fi
          
          # Stop the process
          kill $NPORT_PID 2>/dev/null || true
          sleep 2
          kill -9 $NPORT_PID 2>/dev/null || true
          
          # Show output
          echo ""
          echo "=== nport output ==="
          cat nport_output.log || true
          echo "===================="
          
          # Check for critical errors in output (ignore cloudflared warnings)
          # Only fail on actual nport/installation errors, not cloudflared ICMP warnings
          CRITICAL_ERRORS="Failed to spawn|EACCES|ENOENT|Unsupported architecture|Unsupported platform|Installation failed|not a valid"
          if grep -qiE "$CRITICAL_ERRORS" nport_output.log; then
            echo ""
            echo "❌ Critical errors detected in nport output!"
            exit 1
          fi
          
          if [ "$PROCESS_RUNNING" = false ]; then
            echo ""
            echo "❌ nport process stopped unexpectedly"
            exit 1
          fi
          
          echo ""
          echo "✅ Test passed - no errors detected"

      - name: Run nport and check for errors (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          echo Starting nport on port 3000...
          
          REM Get npm global prefix to find nport
          for /f "tokens=*" %%i in ('npm prefix -g') do set NPM_PREFIX=%%i
          echo NPM prefix: %NPM_PREFIX%
          
          REM Start nport in background using start command
          start /b cmd /c "nport 3000 -l en -s test-${{ matrix.os }}-${{ github.run_id }} > nport_output.log 2>&1"
          
          echo Waiting 30 seconds...
          timeout /t 30 /nobreak > nul
          
          echo.
          echo === nport output ===
          if exist nport_output.log type nport_output.log
          echo ====================
          
          REM Check for critical errors in output (ignore cloudflared warnings)
          findstr /i /c:"Failed to spawn" /c:"EACCES" /c:"ENOENT" /c:"Unsupported architecture" /c:"Unsupported platform" /c:"Installation failed" /c:"not a valid" nport_output.log > nul 2>&1
          if %errorlevel% equ 0 (
            echo.
            echo X Critical errors detected in nport output!
            exit /b 1
          )
          
          echo.
          echo Test passed - no critical errors detected

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nport-logs-${{ matrix.os }}
          path: |
            nport_output.log
            nport_error.log
          retention-days: 7
